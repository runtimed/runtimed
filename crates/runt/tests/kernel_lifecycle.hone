#! shell: /bin/bash
#! timeout: 120s

TEST "start kernel, execute code, and stop kernel"
RUN runt start python3
ASSERT exit_code == 0
ASSERT stdout contains "Kernel started with ID"

TEST "extract kernel ID from previous output"
RUN KERNEL_ID=$(runt start python3 2>&1 | grep "Kernel started" | sed 's/.*ID: //')
RUN echo "Started kernel: $KERNEL_ID"
ASSERT exit_code == 0

TEST "execute simple code in kernel"
RUN KERNEL_ID=$(runt start python3 2>&1 | grep "Kernel started" | sed 's/.*ID: //') && runt exec "$KERNEL_ID" "print('hello from hone test')"
ASSERT exit_code == 0
ASSERT stdout contains "hello from hone test"

TEST "execute code with error returns non-zero exit"
RUN KERNEL_ID=$(runt start python3 2>&1 | grep "Kernel started" | sed 's/.*ID: //') && runt exec "$KERNEL_ID" "raise ValueError('test error')"
ASSERT exit_code == 1
ASSERT stderr contains "ValueError"

TEST "stop kernel successfully"
RUN KERNEL_ID=$(runt start python3 2>&1 | grep "Kernel started" | sed 's/.*ID: //') && sleep 2 && runt stop "$KERNEL_ID"
ASSERT exit_code == 0
ASSERT stdout matches /Kernel with ID [a-z]+-[a-z]+ stopped/

TEST "interrupt kernel successfully"
RUN KERNEL_ID=$(runt start python3 2>&1 | grep "Kernel started" | sed 's/.*ID: //') && sleep 2 && runt interrupt "$KERNEL_ID"
ASSERT exit_code == 0
ASSERT stdout contains "Interrupt sent"

TEST "stop already stopped kernel fails"
RUN KERNEL_ID=$(runt start python3 2>&1 | grep "Kernel started" | sed 's/.*ID: //') && sleep 2 && runt stop "$KERNEL_ID" && runt stop "$KERNEL_ID"
ASSERT exit_code != 0
ASSERT stderr contains "No such file"
