#! shell: pwsh
#! timeout: 180s

TEST "start kernel successfully"
RUN runt start python3
ASSERT exit_code == 0
ASSERT stdout contains "Kernel started with ID"

TEST "start and execute simple code"
RUN $output = runt start python3 2>&1; $id = ($output | Select-String -Pattern 'ID: (.+)$').Matches.Groups[1].Value; runt exec $id "print('hello from hone test')"
ASSERT exit_code == 0
ASSERT stdout contains "hello from hone test"

TEST "start and execute code with error"
RUN $output = runt start python3 2>&1; $id = ($output | Select-String -Pattern 'ID: (.+)$').Matches.Groups[1].Value; runt exec $id "raise ValueError('test error')"
ASSERT exit_code == 1
ASSERT stderr contains "ValueError"

TEST "start and stop kernel"
RUN $output = runt start python3 2>&1; $id = ($output | Select-String -Pattern 'ID: (.+)$').Matches.Groups[1].Value; Start-Sleep -Seconds 2; runt stop $id
ASSERT exit_code == 0
ASSERT stdout matches /Kernel with ID [0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12} stopped/

TEST "start and interrupt kernel"
RUN $output = runt start python3 2>&1; $id = ($output | Select-String -Pattern 'ID: (.+)$').Matches.Groups[1].Value; Start-Sleep -Seconds 2; runt interrupt $id
ASSERT exit_code == 0
ASSERT stdout contains "Interrupt sent"

TEST "stop already stopped kernel fails"
RUN $output = runt start python3 2>&1; $id = ($output | Select-String -Pattern 'ID: (.+)$').Matches.Groups[1].Value; Start-Sleep -Seconds 2; runt stop $id; runt stop $id
ASSERT exit_code != 0
ASSERT stderr contains "No such file"
